<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Klean by Guo Y.K.</title>
    <link rel="stylesheet" href="//unpkg.com/bootswatch@5.2.0/dist/flatly/bootstrap.min.css"/>
    <link rel="stylesheet" href="//unpkg.com/@highlightjs/cdn-assets@11.6.0/styles/default.min.css">
    <style>
        pre {
            white-space: pre-wrap; /* Since CSS 2.1 */
            white-space: -moz-pre-wrap; /* Mozilla, since 1999 */
            white-space: -pre-wrap; /* Opera 4-6 */
            white-space: -o-pre-wrap; /* Opera 7 */
            word-wrap: break-word; /* Internet Explorer 5.5+ */
        }

        .main-box {
            width: 100%;
            height: auto;
            min-height: 600px;
        }

    </style>
</head>
<body>
<div class="container-fluid">
    <div class="row mt-3">
        <div class="col-md-12">
            <h5 class="d-inline-block">Klean</h5>
            <span>(Remove useless fields from an existed Kubernetes resource)</span>
        </div>
    </div>
    <div class="row mt-3">
        <div class="col-md-5">
            <p><b>YAML Input:</b></p>
            <p>
                <textarea class="main-box" id="textarea-input"></textarea>
            </p>
        </div>
        <div class="col-md-7">
            <p><b>Output:</b></p>
            <p>
            <pre><code id="box-output" class="main-box" class="language-json">...</code></pre>
            </p>
        </div>
    </div>
</div>

<script src="//unpkg.com/jquery@3.6.1/dist/jquery.slim.min.js"></script>
<script src="//unpkg.com/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
<script src="//unpkg.com/fast-json-patch@3.1.1/dist/fast-json-patch.min.js"></script>
<script src="//unpkg.com/@highlightjs/cdn-assets@11.6.0/highlight.min.js"></script>
<script src="//unpkg.com/@highlightjs/cdn-assets@11.6.0/languages/yaml.min.js"></script>
<script src="//unpkg.com/@highlightjs/cdn-assets@11.6.0/languages/json.min.js"></script>
<script>
    const PATHS_GENERAL = [
        "/metadata/annotations/deployment.kubernetes.io~1revision",
        "/metadata/annotations/analysis.crane.io~1replicas-recommendation",
        "/metadata/annotations/analysis.crane.io~1resource-recommendation",
        "/metadata/annotations/field.cattle.io~1creatorId",
        "/metadata/annotations/field.cattle.io~1ingressState",
        "/metadata/annotations/field.cattle.io~1publicEndpoints",
        "/metadata/annotations/kubectl.kubernetes.io~1last-applied-configuration",
        "/metadata/creationTimestamp",
        "/metadata/finalizers",
        "/metadata/generation",
        "/metadata/labels/cattle.io~1creator",
        "/metadata/managedFields",
        "/metadata/resourceVersion",
        "/metadata/selfLink",
        "/metadata/uid",
        "/spec/replicas",
        "/spec/template/metadata/annotations/cattle.io~1timestamp",
        "/spec/template/metadata/annotations/net.guoyk.deployer~1timestamp",
        "/spec/template/metadata/annotations/workload.cattle.io~1state",
        "/spec/template/metadata/creationTimestamp",
        "/status",
    ];

    const PATHS_FUCK_RANCHER = [
        "/metadata/labels/workload.user.cattle.io~1workloadselector",
        "/spec/selector/matchLabels/workload.user.cattle.io~1workloadselector",
        "/spec/template/metadata/labels/workload.user.cattle.io~1workloadselector"
    ];

    const PATHS_FUCK_RANCHER_AGAIN = [
        "/metadata/labels/app",
        "/spec/selector/matchLabels/app",
        "/spec/template/metadata/labels/app"
    ];


    function debounce(func, wait, immediate) {
        let timer;

        return function () {
            let context = this;
            let args = arguments;

            if (timer) clearTimeout(timer);
            if (immediate) {
                var callNow = !timer;
                timer = setTimeout(() => {
                    timer = null;
                }, wait)
                if (callNow) func.apply(context, args)
            } else {
                timer = setTimeout(function () {
                    func.apply(context, args)
                }, wait);
            }
        }
    }

    function transform() {
        try {
            $("#box-output").text(doTransform())
            hljs.highlightAll();
        } catch (e) {
            $("#box-output").text(e.toString())
        }
    }

    function doTransform() {
        const doc = jsyaml.load($("#textarea-input").val());
        for (const path of PATHS_GENERAL) {
            jsonpatch.applyOperation(doc, {op: "remove", path})
        }

        // FUCK RANCHER
        if (jsonpatch.getValueByPointer(
            doc,
            "/spec/selector/matchLabels/workload.user.cattle.io~1workloadselector"
        )) {
            const app = jsonpatch.getValueByPointer(doc, "/metadata/name")
            if (app) {
                for (const path of PATHS_FUCK_RANCHER) {
                    jsonpatch.applyOperation(doc, {op: "remove", path})
                }
                for (const path of PATHS_FUCK_RANCHER_AGAIN) {
                    jsonpatch.applyOperation(doc, {op: "replace", path, value: app})
                }
            }
        }

        return JSON.stringify(doc, null, "  ")
    }

    $(document).ready(function () {
        $("#textarea-input").bind('input propertychange', debounce(transform, 200, false));
    });
</script>
</body>
</html>
